#!/usr/bin/env python
# coding: utf-8

# In[1]:


import streamlit as st
import pandas as pd
import numpy as np
import joblib
import shap
import matplotlib.pyplot as plt


# In[2]:


st.title('mortality Risk Prediction for Patients with severe TCSCI')


# In[5]:


#1.Age
Age= st.number_input(label='Age(y)')
#2 CCI
CCI=st.slider(label='Charlson Comorbidity Index')
#3.ISS
ISS=st.slider(label='Injury severity score')
#4 Thoracic and abdominal organs damage
Thoracic_abdominal_organs_damage=st.radio(label='Thoracic abdominal organs damage',options=['Non-damage','Single','multiple'])
#5 Cervical fracture
Cervical_fracture=st.radio(label='Cervical fracture',options=['Non-fractures','Upper(C1-2)','Lower(C3-7)'])
#6.NLI
NLI=st.radio(label='NLI',options=['C1-C4','C5-C8'])
#7 Time of injury
Time_injury=st.slider(label='Time of injury')
#8 Surgery timing
Surgery_timing=st.radio(label='Surgery Timing',
                   options=['Non-surgery','Early','Delay'])
#9.Transfusion
Transfusion=st.radio(label='Transfusion',options=['No surgery','Surgery with transfusion','Surgery without transfusion'])
#10.Critical care
Critical_care=st.radio(label='Critical care',options=['No','Yes'])
#11. Nourishment
Nourishment=st.radio(label='Nourishment',
                   options=['Normal','Enteral','Parenteral'])


# In[7]:


#采集数据
if st.button("Predict"):
    # Unpickle classifier
    RSF = joblib.load("RSF.pkl")
    data=[
    [46,1,27,0,0,1,1,2,2,1,1],[63,5,34,1,2,1,6,2,2,0,1],[54,3,34,0,2,0,1,2,1,0,1],[41,1,41,2,2,1,1,2,2,1,2],[65,3,26,1,0,0,2,2,1,0,1],
[22,0,29,1,2,0,2,2,1,0,2],[75,5,20,0,0,0,1,2,1,0,0],[63,4,29,0,2,0,4,2,1,1,2],[45,1,29,1,2,1,3,2,1,1,1],[60,3,15,0,2,0,1,2,1,0,0],
[49,1,25,0,2,0,1,1,1,1,2],[67,3,26,0,0,1,1,1,1,1,0],[46,1,25,1,2,1,2,1,1,1,2],[65,2,25,0,2,1,2,2,2,1,1],[43,1,25,0,2,0,1,1,1,1,1],
[57,2,20,0,2,0,2,2,2,1,1],[27,0,27,0,2,0,5,2,1,0,0],[39,0,42,1,2,1,1,2,1,1,2],[66,3,27,0,2,1,1,1,1,1,0],[58,2,17,0,1,1,1,2,1,1,1],
[64,3,42,2,2,0,1,0,0,1,1],[61,4,27,0,0,1,2,0,0,0,0],[45,3,16,0,1,1,5,2,1,0,0],[42,1,26,0,2,0,1,1,2,1,1],[52,2,25,0,2,0,3,2,1,0,1],
[52,2,29,1,2,0,2,2,1,1,0],[42,1,45,0,2,1,1,1,1,1,2],[68,4,30,2,2,0,6,2,2,1,2],[38,0,29,0,1,1,1,1,2,1,1],[60,2,36,2,1,1,3,2,1,0,1],
[46,1,26,0,2,1,2,2,1,0,1],[70,6,27,0,2,0,1,1,1,0,1],[25,0,20,0,2,0,1,2,1,0,0],[60,1,25,0,0,1,1,2,1,0,0],[21,0,29,0,2,1,1,1,2,1,1],
[52,2,16,0,2,0,3,2,1,0,0],[60,2,25,0,0,1,2,0,0,1,1],[60,4,27,0,0,1,3,0,0,0,0],[46,1,42,1,2,1,1,1,1,0,1],[48,1,17,0,2,0,1,1,1,0,0],
[52,1,17,2,2,0,7,2,1,1,2],[43,1,25,0,0,0,6,2,1,1,2],[27,0,16,0,0,1,4,2,1,0,0],[37,0,17,0,0,1,1,2,1,0,0],[61,3,29,1,1,1,2,2,1,1,2],
[52,2,17,0,0,0,4,2,1,0,0],[40,1,29,0,2,0,1,2,1,0,1],[42,1,20,0,2,0,3,2,1,0,1],[58,2,16,0,0,0,1,2,1,0,0],[46,1,16,0,2,1,3,2,1,0,0],
[39,0,25,0,0,0,1,1,2,1,1],[17,0,25,0,2,0,1,1,1,0,0],[57,2,20,0,1,1,1,2,2,1,2],[61,3,20,1,0,1,7,2,1,1,1],[54,3,42,1,1,1,2,2,1,1,2],
[43,1,25,0,2,1,1,2,1,1,2],[49,1,35,1,1,1,2,1,2,1,2],[50,1,25,0,1,1,1,1,1,1,1],[55,2,26,0,2,0,7,2,1,1,1],[19,0,25,0,0,1,1,1,1,1,1],
[65,3,26,0,2,1,1,1,1,1,1],[48,2,45,2,1,1,1,0,0,1,2],[67,3,25,0,0,0,2,2,1,1,2],[49,2,34,1,1,1,1,1,1,1,2],[47,1,18,0,0,1,1,0,0,0,2],
[40,0,26,0,2,1,2,2,2,1,2],[35,0,34,0,2,0,7,2,1,0,0],[57,2,38,1,2,0,1,2,1,1,1],[54,1,38,1,2,1,6,2,1,1,2],[49,1,30,2,2,1,1,1,1,1,1],
[43,2,42,2,1,1,3,0,0,1,2],[57,4,35,1,2,1,7,2,2,1,1],[51,2,29,1,2,0,4,2,1,1,2],[59,2,26,1,2,0,2,2,1,1,1],[15,0,34,1,2,1,3,0,0,1,1],
[33,0,26,0,0,1,7,2,1,0,1],[63,3,16,0,2,0,1,0,0,0,0],[54,2,26,0,2,0,1,1,1,1,2],[52,2,25,0,2,0,2,2,1,0,0],[29,0,25,1,2,1,1,1,1,0,0],
[58,2,29,0,1,1,4,2,1,0,1],[62,3,20,1,1,0,1,2,1,0,1],[22,0,34,0,2,1,1,1,2,1,2],[68,3,33,0,1,1,2,2,1,1,2],[44,0,38,1,2,1,1,1,1,0,2],
[49,1,25,0,2,0,1,1,1,1,1],[20,0,29,1,2,1,1,1,1,1,1],[34,0,30,1,0,1,4,0,0,0,0],[64,4,41,1,1,1,3,2,2,1,2],[25,0,25,0,2,0,3,2,1,0,0],
[62,3,26,1,0,1,3,2,1,1,1],[62,3,38,1,2,1,1,1,1,1,1],[45,1,35,2,2,1,1,2,1,1,2],[57,2,20,1,1,0,1,2,1,0,0],[56,2,25,0,0,0,2,1,2,1,2],
[44,1,26,0,2,0,2,1,1,1,1],[68,4,20,0,0,1,4,2,1,1,1],[45,1,26,1,2,0,1,2,1,0,1],[22,0,16,0,0,0,5,2,1,0,0],[40,1,25,0,2,1,2,1,2,1,2],
[31,0,38,1,2,0,1,2,1,0,2],[39,0,33,1,2,1,1,1,1,0,1],[30,0,30,0,2,1,1,1,2,0,0],[22,0,25,0,2,1,2,1,1,1,1],[37,0,16,1,2,0,1,2,1,0,0],
[41,1,16,0,2,0,2,2,1,1,1],[65,4,16,0,2,1,2,2,1,0,0],[54,2,16,0,2,0,9,2,1,0,0],[53,3,21,1,2,1,1,2,1,1,2],[57,2,16,0,2,0,1,1,1,0,0],
[61,3,15,1,2,0,1,2,1,0,1],[48,1,26,0,0,1,1,2,1,1,2],[60,2,25,0,0,1,1,2,1,0,0],[32,0,34,1,2,0,3,2,1,1,1],[51,2,16,0,2,1,1,1,1,1,0],
[48,2,34,0,1,1,1,1,2,1,2],[24,0,25,0,2,0,4,2,1,1,1],[57,2,26,0,2,1,1,0,0,0,0],[28,0,34,0,2,1,2,2,2,1,1],[66,3,17,0,0,1,1,2,1,0,0],
[27,0,25,0,2,0,2,2,1,0,1],[49,1,35,1,2,1,2,2,1,1,2],[29,1,29,0,2,0,2,2,2,0,0],[33,0,43,0,2,1,5,2,1,1,2],[55,2,17,0,2,1,2,2,1,0,0],
[49,2,42,1,2,0,1,0,0,1,2],[27,0,17,0,0,0,1,2,1,0,0],[52,2,50,2,1,1,8,2,1,1,2],[34,0,29,0,2,0,1,2,1,1,2],[57,2,25,0,0,1,3,2,1,1,1],
[51,2,30,0,2,0,3,2,1,0,1],[44,0,38,1,2,1,6,2,1,1,2],[55,2,21,1,2,1,6,2,1,1,2],[55,2,27,0,1,1,1,2,2,0,1],[45,2,33,0,2,1,2,0,0,1,0],
[42,1,38,1,2,0,1,1,2,0,1],[70,4,25,1,1,1,3,0,0,0,0],[48,1,36,1,2,1,5,2,2,1,2],[55,2,34,1,2,1,2,2,1,1,2],[57,2,25,1,0,1,1,2,1,1,2],
[43,1,25,0,2,0,1,1,1,1,1],[65,3,42,2,2,0,2,2,1,1,2],[68,3,25,0,0,0,3,2,1,0,1],[41,1,25,0,2,1,4,2,1,1,2],[59,2,30,1,2,1,3,2,1,1,2],
[30,0,25,0,2,1,3,2,1,1,2],[51,2,26,0,2,1,1,2,1,1,1],[23,0,26,0,2,0,3,2,2,1,1],[55,2,38,1,1,1,3,2,1,1,2],[62,3,25,1,0,0,2,2,1,0,2],
[57,1,38,1,2,1,5,2,1,1,2],[72,5,38,1,2,1,1,2,1,1,2],[75,5,25,0,0,1,3,0,0,1,1],[65,4,42,1,2,1,8,0,0,1,2],[48,2,25,0,2,0,3,2,1,0,1],
[54,3,21,1,0,0,1,1,1,0,0],[56,2,25,0,2,0,2,1,1,0,1],[24,0,29,0,2,0,3,2,1,1,1],[50,2,38,1,2,0,2,2,1,1,2],[27,0,35,0,2,0,1,2,1,1,2],
[43,1,36,1,2,1,6,2,1,0,0],[51,4,26,1,2,0,2,2,1,0,1],[41,1,27,0,2,1,1,0,0,1,1],[37,0,25,0,2,1,1,2,1,1,2],[59,2,35,1,2,0,2,1,2,1,1],
[33,1,25,0,2,1,1,1,1,1,2],[36,0,29,1,2,1,1,1,1,1,2],[53,2,21,1,2,1,1,1,1,0,0],[39,0,34,1,2,1,7,2,1,0,1],[61,3,43,2,2,1,5,2,1,1,2],
[56,4,35,0,2,1,1,1,2,0,0],[37,0,38,0,2,1,2,1,1,1,2],[35,0,36,2,1,1,8,2,1,1,2],[60,2,25,1,0,1,1,1,1,1,2],[41,0,42,1,2,1,2,2,2,1,2],
[45,1,16,0,2,1,8,2,1,0,0],[55,2,17,0,2,0,4,2,1,0,0],[55,3,16,0,0,0,1,2,2,0,0],[59,2,25,1,2,0,1,2,1,1,1],[70,3,40,0,2,1,1,1,2,0,2],
[24,0,34,0,2,1,1,2,1,1,2],[59,2,45,1,1,1,1,1,1,1,1],[48,1,25,0,0,1,1,1,2,1,2],[51,2,26,0,0,0,1,1,1,1,1],[33,0,34,1,2,1,3,2,1,1,2],
[27,0,35,1,2,1,4,2,1,1,1],[51,3,27,0,2,1,4,2,1,1,1],[42,1,42,2,2,1,1,0,0,1,2],[74,4,16,0,2,0,2,2,1,1,1],[54,2,16,0,0,0,6,2,1,1,1],
[55,3,42,1,2,1,4,2,1,1,2],[51,2,25,0,0,1,1,1,1,1,1],[50,2,41,0,1,1,1,2,1,1,2],[20,0,38,1,2,1,2,2,1,1,2],[57,3,26,1,0,1,1,0,0,0,0],
[61,3,38,2,2,0,3,0,0,0,1],[30,0,20,0,2,1,1,2,2,0,0],[52,2,29,1,2,1,1,1,1,1,2],[47,1,26,1,0,1,7,2,2,1,0],[64,3,26,0,0,0,1,1,2,1,2],
[43,1,25,1,1,1,5,2,1,0,0],[67,3,18,0,0,0,4,2,1,0,1],[65,3,25,0,0,0,3,2,1,1,0],[56,3,42,1,2,1,2,2,2,1,2],[54,1,38,1,2,0,4,2,2,1,2],
[43,1,30,1,1,1,1,1,1,1,2],[46,1,25,0,0,1,5,2,1,1,1],[42,1,25,1,2,1,1,2,2,0,1],[33,0,25,0,0,1,1,2,2,0,1],[62,4,30,2,2,0,1,0,0,0,2],
[54,2,20,0,2,1,3,2,1,1,1],[43,1,21,0,2,0,1,0,0,0,2],[57,2,30,1,2,0,5,2,2,1,2],[20,0,20,1,2,1,2,0,0,0,1],[59,2,17,0,0,1,2,1,1,1,1],
[59,2,34,0,2,0,5,2,1,0,2],[54,2,16,0,2,1,1,2,1,0,0],[48,2,25,1,2,1,3,2,1,1,2],[44,1,30,1,2,1,1,2,1,1,2],[51,2,21,0,1,1,1,1,1,0,0],
[72,4,17,0,2,0,3,0,0,1,1],[55,2,30,1,2,0,1,1,1,0,1],[58,2,30,0,2,1,2,1,2,1,1],[59,3,25,2,0,1,3,0,0,0,0],[54,2,21,0,0,1,5,2,1,0,0],
[47,2,30,0,2,0,1,1,1,1,2],[57,2,25,0,2,0,1,1,1,1,2],[79,4,30,1,2,0,7,0,0,1,0],[21,0,25,1,1,1,1,2,1,0,0],[58,3,41,2,2,1,1,2,1,1,1],
[33,0,26,0,1,1,2,2,1,1,1],[35,0,25,0,2,1,1,2,1,0,0],[49,1,41,1,2,1,2,2,1,1,2],[58,2,25,0,0,1,1,2,1,1,1],[51,2,25,0,2,1,1,0,0,0,0],
[38,0,16,0,2,1,1,2,1,0,1],[44,1,29,0,2,1,1,1,1,0,1],[47,1,43,1,2,1,4,2,1,1,2],[25,0,41,1,2,1,1,1,1,1,2],[29,0,17,1,2,1,1,2,1,1,2],
[57,2,33,0,2,1,2,2,1,0,0],[36,0,25,0,2,1,1,1,1,1,1],[47,1,26,0,2,0,1,1,1,1,1],[58,2,16,0,2,0,1,1,1,0,0],[37,0,16,0,2,1,3,2,2,0,1],
[44,1,26,0,2,0,1,2,2,1,2],[46,1,26,1,2,0,1,1,1,1,2],[62,3,26,0,0,0,1,2,1,0,1],[49,1,25,1,2,0,1,2,1,1,1],[66,4,26,0,2,1,1,1,1,1,2],
[59,1,26,0,2,1,1,1,1,1,2],[56,2,16,0,2,1,2,2,1,1,1],[49,1,38,0,2,0,2,1,1,0,0],[43,2,38,0,2,0,3,2,2,1,2],[46,1,17,0,2,0,6,2,1,0,0],
[43,1,20,1,2,0,1,1,1,0,1],[29,0,16,0,2,0,4,2,2,0,0],[49,1,34,1,1,1,1,0,0,0,1],[47,1,20,1,0,1,2,1,1,1,0],[50,1,42,1,2,0,1,2,2,1,2],
[56,2,26,0,2,0,1,2,1,0,0],[60,2,18,0,2,1,4,2,1,1,0],[35,0,20,1,2,0,1,2,2,0,1],[46,1,34,0,2,1,5,2,1,1,0],[62,2,35,0,2,0,1,2,2,1,2],
[44,1,36,1,2,1,1,2,1,1,2],[36,0,18,1,0,0,1,2,1,0,0],[41,1,17,0,2,1,2,1,1,0,1],[73,4,25,0,2,0,1,2,1,0,0],[15,0,25,0,2,1,3,2,1,0,0],
[33,0,24,1,0,1,3,2,2,1,1],[23,0,26,2,2,0,1,0,0,0,2],[55,2,16,0,2,1,3,2,1,1,0],[48,1,27,1,1,1,5,2,1,1,1],[62,3,17,0,2,1,4,2,1,1,1],
[61,2,35,0,2,1,1,1,2,1,2],[44,1,27,0,0,0,1,1,1,1,1],[70,4,25,0,2,1,2,1,2,0,1],[41,0,25,0,0,1,2,2,1,1,1],[20,1,32,0,1,1,1,2,1,1,0],
[41,0,21,0,2,0,4,2,1,1,1],[61,4,38,1,2,0,1,2,1,1,2],[58,3,30,0,2,1,1,1,1,1,2],[65,4,35,1,2,1,1,1,1,1,1],[50,2,40,2,1,1,1,2,2,1,2],
[48,1,18,1,2,1,1,2,1,1,2],[30,0,45,2,2,0,8,2,2,1,2],[25,0,35,1,1,1,7,2,2,1,2],[52,2,26,1,2,0,4,2,1,1,1],[61,5,21,1,2,0,2,1,2,0,0],
[62,3,30,0,2,1,1,2,1,0,2],[50,1,31,0,2,1,1,0,0,0,0],[48,1,30,0,0,1,2,0,0,0,2],[46,1,25,0,2,1,6,2,1,1,1],[30,0,45,1,2,1,2,0,0,1,2],
[67,3,27,0,0,1,1,0,0,0,0],[56,4,45,2,2,0,1,0,0,1,2],[58,2,26,1,2,0,1,2,1,1,2],[45,1,25,2,1,1,3,2,1,1,2],[51,2,17,0,0,0,1,2,1,1,1],
[68,3,42,2,2,0,1,1,1,1,2],[66,3,35,0,2,1,1,1,1,1,1],[22,0,38,0,2,0,1,2,2,1,2],[33,0,29,1,1,1,1,1,1,0,1],[55,2,17,0,0,1,2,2,1,1,0],
[47,1,26,0,0,0,1,1,1,1,1],[31,0,16,0,2,1,1,1,1,0,0],[33,2,33,0,2,1,1,1,2,0,1],[32,0,26,0,0,1,1,1,2,1,1],[57,3,29,0,2,1,1,2,1,1,2],
[25,0,41,1,1,1,1,1,2,1,2],[50,2,16,0,0,0,1,2,1,0,0],[59,3,38,2,1,1,1,2,2,1,1],[48,1,26,0,2,0,2,1,1,1,1],[24,0,32,1,2,1,3,2,1,1,2],
[42,1,42,1,2,1,1,2,1,1,2],[46,1,26,0,2,0,2,1,1,0,1],[58,2,33,0,2,1,1,2,2,0,0],[47,2,51,2,2,1,4,0,0,1,2],[59,2,26,0,0,1,2,0,0,0,0],
[68,4,17,1,2,0,1,1,1,0,0],[65,3,17,1,0,0,1,2,2,1,1],[56,4,17,0,2,0,1,2,2,0,0],[68,5,42,1,2,1,3,2,2,1,2],[56,2,30,0,2,0,1,0,0,1,2],
[69,4,27,0,2,1,1,2,2,1,1],[50,1,16,0,0,1,5,2,2,0,0],[45,0,36,1,2,1,5,2,1,1,1],[43,1,33,0,2,1,2,2,1,0,2],[66,3,24,0,0,0,1,1,1,0,0],
[49,1,16,0,2,0,1,2,1,0,0],[33,0,25,1,1,1,1,1,1,1,2],[43,1,33,0,2,1,1,2,1,1,1],[15,0,16,0,2,1,1,0,0,0,1],[36,1,26,0,2,1,1,1,1,1,2],
[50,2,26,0,2,0,1,2,1,1,1],[52,1,30,1,2,0,1,1,1,1,1],[23,0,17,0,2,0,3,2,1,0,0],[18,0,20,0,2,1,4,2,2,1,1],[33,0,42,1,2,0,3,0,0,1,1],
[33,0,24,1,2,1,6,2,2,0,0],[39,0,25,0,2,0,1,2,1,1,1],[49,1,42,1,2,1,2,2,1,0,2],[38,0,20,0,2,0,1,2,1,1,1],[49,2,16,0,0,1,1,2,1,1,1],
[74,4,42,0,2,1,1,2,1,1,2],[43,1,26,0,2,1,7,2,2,0,1],[46,2,25,0,2,1,1,2,1,0,1],[37,0,21,2,0,0,1,2,1,0,2],[36,0,38,1,2,1,1,2,2,1,1],
[39,0,29,1,2,1,1,2,1,1,2],[59,3,26,1,0,0,1,2,1,0,1],[30,1,35,1,2,1,2,0,0,1,1]]
    X_train= pd.DataFrame(data=data,columns=['Age', 'CCI','ISS','Thoracic and abdominal organs damage','Cervical fracture',
                              'NLI','Time of injury','Surgery timing','Transfusion','Critical care','Nourishment'])
    explainer = shap.Explainer(RSF.predict,X_train)
    # Store inputs into dataframe
    X = pd.DataFrame([[Age,CCI,ISS,Thoracic_abdominal_organs_damage,Cervical_fracture,NLI,Time_injury,
                    Surgery_timing,Transfusion,Critical_care,Nourishment]], 
                    columns = ['Age', 'CCI','ISS','Thoracic and abdominal organs damage','Cervical fracture',
                              'NLI','Time of injury','Surgery timing','Transfusion','Critical care','Nourishment'])
    X = X.replace(["C1-C4", "C5-C8"], [1, 0])
    X = X.replace(["Yes", "No"], [1, 0])
    X = X.replace(['Non-damage','Single','multiple'], [0,1,2])
    X = X.replace(['Non-fractures','Upper(C1-2)','Lower(C3-7)'], [0,1,2])
    X = X.replace(['Non-surgery','Early','Delay'], [0,1,2])
    X = X.replace(['Normal','Enteral','Parenteral'], [0,1,2])
    X = X.replace(['No surgery','Surgery with transfusion','Surgery without transfusion'],[0,1,2])
    #结果
    def survival_time(model,patient):
        va_times=np.arange(0,60)
        chf_funcs=model.predict_cumulative_hazard_function(patient)
        Time=()
        for fn in chf_funcs:#
            if fn(va_times[-1])<0.5:#在最后的预测时间内死亡全部累计概率不到0.6
                time_value=999
                Time=('This patient had no predicted death for 60 months')
                return Time
            else:
                for time in va_times:
                    if fn(time)>1:
                        time_value=time#发生结局的最短时间
                        break
                Time=('According to our model, the psurvival time of the patient is expected to be {} months'.format(time)) 
                return Time
    prediction = RSF.predict(X)[0]
    patient = X[X.index==0]
    ST = survival_time(RSF,patient)
    
    def risk_groups(model,patient):
        y_risk=model.predict(patient)
        group=()
        for fn in y_risk:#
            if fn<20:
                group=('Low-risk group')
                return group
            if 20<=fn<45.5:
                group=('Medium-risk group')
                return group
            if fn>=45.5:
                group=('High-risk group')
                return group 
    #预测死亡时间
    patient = X[X.index==0]
    rg=risk_groups(RSF,patient)
    shap_values = explainer(patient)
    shap.plots.force(shap_values,matplotlib=True,show=False,contribution_threshold=0.01)
    plt.savefig("shap_force_plot.png", bbox_inches='tight', dpi=1200)
    # Output prediction
    st.header('outcome prediction')
    st.text(f"mortality risk:{rg}")
    st.text(f"Predicting Outcomes:{ST}")
    st.image("shap_force_plot.png")


# In[ ]:




